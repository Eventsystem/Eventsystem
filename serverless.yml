service:
  name: BusinessEvents-SubscriptionEngine
  awsKmsKeyArn: ${self:custom.${opt:data-center}.KMS_KEY_ARN}
custom: ${file(./serverless-environment-variables.yml)}
provider:
  name: aws
  runtime: dotnetcore1.0
  stage: v1
  region: ap-southeast-2
  deploymentBucket: pageup-serverless-${opt:data-center}-deploy
  iamRoleStatements:
    - Effect: "Allow"
      Resource: "*"
      Action:
        - "sns:*"
        - "logs:CreateLogGroup"
        - "logs:CreateLogStream"
        - "logs:PutLogEvents"
        - "logs:DescribeLogGroups"
        - "logs:DescribeLogStreams"
        - "s3:PutObject"
        - "s3:GetObject"
        - "s3:CreateBucket"
        - "s3:PutBucket"
    - Effect: "Allow"
      Resource: "arn:aws:lambda:*:*:function:integration*"
      Action:
        - "lambda:*"

package:
  artifact: src/BusinessEvents.SubscriptionEngine.Handlers/bin/release/netcoreapp1.0/publish/deploy-package.zip

functions:
  handle:
    handler: BusinessEvents.SubscriptionEngine.Handlers::BusinessEvents.SubscriptionEngine.Handlers.Handler::Handle
    awsKmsKeyArn: ${self:custom.${opt:data-center}.KMS_KEY_ARN}
    events:
      - sns: BusinessEvents
    environment:
      AUTH_CLIENT_ID: ${self:custom.${opt:data-center}.AUTH_CLIENT_ID}
      AUTH_ENDPOINT: ${self:custom.${opt:data-center}.AUTH_ENDPOINT}
      AUTH_CLIENT_SECRET: ${self:custom.${opt:data-center}.AUTH_CLIENT_SECRET}
      DATA_CENTER: ${opt:data-center}
  healthcheck:
    handler: BusinessEvents.SubscriptionEngine.Handlers::BusinessEvents.SubscriptionEngine.Handlers.Handler::HealthCheck
    events:
      - http:
          path: healthcheck
          method: get
          cors: true